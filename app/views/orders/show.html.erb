<h1>Order Invoice</h1>

<p><strong>Status:</strong> <%= @order.status %></p>
<p><strong>Total:</strong> $<%= @order.total %></p>

<h2>Items:</h2>
<ul>
  <% subtotal = 0 %>
  <% @order.order_items.each do |item| %>
    <% item_total = item.price * item.quantity %>
    <% subtotal += item_total %>
    <li style="margin-bottom: 20px;">
      <% if item.product.image.attached? %>
        <%= image_tag item.product.image, width: 100, style: "vertical-align: middle; margin-right: 10px;" %>
      <% end %>
      <strong><%= item.product.name %></strong> —
      Qty: <%= item.quantity %> —
      $<%= item_total %>
    </li>
  <% end %>
</ul>

<% province = @order.user.province %>
<% gst_rate = province.gst.to_f %>
<% pst_rate = province.pst.to_f %>
<% hst_rate = province.hst.to_f %>
<% gst_amount = (subtotal * gst_rate).round(2) %>
<% pst_amount = (subtotal * pst_rate).round(2) %>
<% hst_amount = (subtotal * hst_rate).round(2) %>
<% total_tax = gst_amount + pst_amount + hst_amount %>

<% @tax_amount = total_tax %> <!-- This allows you to reference it below -->

<p><strong>Province:</strong> <%= province.name %></p>
<p>GST: <%= gst_rate %> | PST: <%= pst_rate %> | HST: <%= hst_rate %></p>

<h2>Billing Summary</h2>
<p><strong>Subtotal:</strong> $<%= (@order.total - @tax_amount).round(2) %></p>
<p><strong>Tax:</strong> $<%= @tax_amount.round(2) %></p>
<p><strong>Total (incl. tax):</strong> $<%= @order.total.round(2) %></p>
